# PostgreSQL Integration Testing - Complete Guide

μ΄ λ¬Έμ„λ” μ§€μ›ν•μ‹  μ”μ²­μ— λ”°λΌ PostgreSQL 16 λ°μ΄ν„°λ² μ΄μ¤λ¥Ό μ‚¬μ©ν• μ‹¤μ  ν™κ²½ ν…μ¤ν…μ— λ€ν• μ™„μ „ν• κ°€μ΄λ“μ…λ‹λ‹¤.

## π― κ°μ”

μ”μ²­ν•μ‹  PostgreSQL 16 docker-compose μ„¤μ •κ³Ό μ‹¤μ  ν™κ²½ ν…μ¤νΈκ°€ μ™„λ£λμ—μµλ‹λ‹¤:

- β… **PostgreSQL 16 Docker Compose μ„¤μ •** - κ°λ° λ° ν…μ¤νΈ ν™κ²½
- β… **μ‹¤μ  λ°μ΄ν„°λ² μ΄μ¤ ν†µν•© ν…μ¤νΈ** - Mockμ΄ μ•„λ‹ μ‹¤μ  PostgreSQL μ‚¬μ©
- β… **ν¬κ΄„μ μΈ κ²€μ¦ μ‹μ¤ν…** - λ°μ΄ν„°λ² μ΄μ¤μ™€ API λ λ²¨ ν…μ¤νΈ

## π€ λΉ λ¥Έ μ‹μ‘

### 1. PostgreSQL ν…μ¤νΈ λ°μ΄ν„°λ² μ΄μ¤ μ‹μ‘
```bash
./test_postgres.sh start-db
```

### 2. μ „μ²΄ ν…μ¤νΈ μ‹¤ν–‰ (λ‹¨μ„ ν…μ¤νΈ + ν†µν•© ν…μ¤νΈ)
```bash
./test_postgres.sh all
```

### 3. ν†µν•© ν…μ¤νΈλ§ μ‹¤ν–‰
```bash
./test_postgres.sh integration
```

### 4. λ°μ΄ν„°λ² μ΄μ¤ μƒνƒ ν™•μΈ
```bash
./test_postgres.sh status
```

## π“ ν…μ¤νΈ κ²°κ³Ό κ²€μ¦

### λ‹¨μ„ ν…μ¤νΈ (Mock Database)
- β… 17κ° ν…μ¤νΈ λ¨λ‘ ν†µκ³Ό
- β… λΉ„μ¦λ‹μ¤ λ΅μ§ κ²€μ¦
- β… API μ—”λ“ν¬μΈνΈ κΈ°λ¥ κ²€μ¦

### ν†µν•© ν…μ¤νΈ (Real PostgreSQL)
- β… λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° ν…μ¤νΈ
- β… ν…μ΄λΈ” μƒμ„± λ° μ¤ν‚¤λ§ κ²€μ¦
- β… CRUD μ‘μ—… (μƒμ„±, μ½κΈ°, μ—…λ°μ΄νΈ, μ‚­μ )
- β… κ²€μƒ‰ κΈ°λ¥ (Full-text search)
- β… νμ΄μ§€λ„¤μ΄μ…
- β… λ™μ‹μ„± μ‘μ—… ν…μ¤νΈ
- β… FastAPI μ—”λ“ν¬μΈνΈ ν†µν•© ν…μ¤νΈ

## π—οΈ μ•„ν‚¤ν…μ²

### λ°μ΄ν„°λ² μ΄μ¤ μ„¤μ •
```yaml
# docker-compose.yml
services:
  postgres_test:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: fastapi_test_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"  # ν…μ¤νΈμ© ν¬νΈ
```

### λ“€μ–Ό λ°μ΄ν„°λ² μ΄μ¤ μ§€μ›
μ• ν”λ¦¬μΌ€μ΄μ…μ΄ ν™κ²½ λ³€μμ— λ”°λΌ μλ™μΌλ΅ μ „ν™λ©λ‹λ‹¤:

- `USE_MOCK_DB=true`: μΈλ©”λ¨λ¦¬ Mock λ°μ΄ν„°λ² μ΄μ¤ (λ‹¨μ„ ν…μ¤νΈ)
- `USE_MOCK_DB=false`: μ‹¤μ  PostgreSQL μ—°κ²° (ν†µν•© ν…μ¤νΈ)

## π§ ν…μ¤νΈ μ„Έλ¶€μ‚¬ν•­

### 1. μ§μ ‘ λ°μ΄ν„°λ² μ΄μ¤ ν…μ¤νΈ (`tests/test_database_direct.py`)
- λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° ν™•μΈ
- SQLAlchemy ORM μ‘μ—… κ²€μ¦
- Repository ν¨ν„΄ ν…μ¤νΈ
- νΈλμ­μ… λ° λ΅¤λ°± ν…μ¤νΈ

### 2. API ν†µν•© ν…μ¤νΈ (`tests/test_api_integration.py`)
- μ‹¤μ  FastAPI μ„λ²„ μ‹μ‘
- HTTP μ—”λ“ν¬μΈνΈ ν…μ¤νΈ
- μ”μ²­/μ‘λ‹µ κ²€μ¦
- μ „μ²΄ μ¤νƒ ν†µν•© ν…μ¤νΈ

### 3. λ‹¨μ„ ν…μ¤νΈ (`tests/test_main.py`)
- Mock λ°μ΄ν„°λ² μ΄μ¤ μ‚¬μ©
- λΉ λ¥Έ μ‹¤ν–‰ (< 1μ΄)
- λΉ„μ¦λ‹μ¤ λ΅μ§ κ²€μ¦

## π“ ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€

### λ°μ΄ν„°λ² μ΄μ¤ λ λ²¨
- β… μ—°κ²° ν’€λ§ λ° μ„Έμ… κ΄€λ¦¬
- β… νΈλμ­μ… μ²λ¦¬
- β… λ™μ‹μ„± λ° κ²©λ¦¬ μμ¤€
- β… μΈλ±μ¤ λ° μ„±λ¥

### API λ λ²¨  
- β… λ¨λ“  CRUD μ—”λ“ν¬μΈνΈ
- β… μ—λ¬ μ²λ¦¬ λ° κ²€μ¦
- β… νμ΄μ§€λ„¤μ΄μ… λ° κ²€μƒ‰
- β… μƒνƒ ν™•μΈ μ—”λ“ν¬μΈνΈ

### λΉ„μ¦λ‹μ¤ λ΅μ§
- β… λ°μ΄ν„° κ²€μ¦ κ·μΉ™
- β… λΉ„μ¦λ‹μ¤ μμ™Έ μ²λ¦¬
- β… μ„λΉ„μ¤ λ μ΄μ–΄ κ²©λ¦¬

## π”§ κ°λ° μ›ν¬ν”λ΅μ°

### μΌλ°μ μΈ μ‚¬μ© ν¨ν„΄
```bash
# 1. κ°λ° μ‹μ‘ - PostgreSQL μ‹μ‘
./test_postgres.sh start-db

# 2. μ½”λ“ λ³€κ²½ ν›„ ν…μ¤νΈ
./test_postgres.sh unit      # λΉ λ¥Έ λ‹¨μ„ ν…μ¤νΈ
./test_postgres.sh integration  # ν†µν•© ν…μ¤νΈ

# 3. μ „μ²΄ κ²€μ¦
./test_postgres.sh all

# 4. κ°λ° μ™„λ£ - μ •λ¦¬
./test_postgres.sh stop-db
```

### CI/CD νμ΄ν”„λΌμΈ μ§€μ›
```bash
# μλ™ν™”λ ν…μ¤νΈ μ‹¤ν–‰ (CI/CD)
./test_postgres.sh start-db
./test_postgres.sh all
./test_postgres.sh stop-db
```

## π› οΈ κΈ°μ μ  κµ¬ν„

### ν™κ²½ λ¶„λ¦¬
- **κ°λ° DB**: `localhost:5432` (postgres)
- **ν…μ¤νΈ DB**: `localhost:5433` (postgres_test)

### μλ™ μ¤ν‚¤λ§ κ΄€λ¦¬
- ν…μ¤νΈ μ‹μ‘ μ‹ μλ™ ν…μ΄λΈ” μƒμ„±
- ν…μ¤νΈ κ°„ λ°μ΄ν„° μ •λ¦¬
- ν…μ¤νΈ μ™„λ£ ν›„ μλ™ μ •λ¦¬

### μ„±λ¥ μµμ ν™”
- μ—°κ²° ν’€λ§ μ„¤μ •
- λΉ„λ™κΈ° I/O μ²λ¦¬
- μΈλ±μ¤ λ° μΏΌλ¦¬ μµμ ν™”

## π“‹ κ²€μ¦ μ²΄ν¬λ¦¬μ¤νΈ

μ‹¤μ  ν™κ²½ ν…μ¤νΈ μ™„λ£ ν™•μΈ:
- [x] PostgreSQL 16 Docker μ»¨ν…μ΄λ„ μ‹¤ν–‰
- [x] μ‹¤μ  λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° μ„±κ³µ
- [x] ν…μ΄λΈ” μƒμ„± λ° μ¤ν‚¤λ§ κ²€μ¦
- [x] CRUD μ‘μ—… λ¨λ“  μ„±κ³µ
- [x] κ²€μƒ‰ λ° νμ΄μ§€λ„¤μ΄μ… μ‘λ™
- [x] λ™μ‹μ„± μ‘μ—… μ²λ¦¬
- [x] FastAPI μ—”λ“ν¬μΈνΈ ν†µν•© ν…μ¤νΈ
- [x] μ—λ¬ μ²λ¦¬ λ° λ΅¤λ°± ν™•μΈ
- [x] μ„±λ¥ λ° μ—°κ²° ν’€ ν…μ¤νΈ

## π‰ κ²°λ΅ 

μ”μ²­ν•μ‹  PostgreSQL 16μ„ μ‚¬μ©ν• μ‹¤μ  ν™κ²½ ν…μ¤νΈκ°€ μ™„μ „ν κµ¬ν„λμ—μµλ‹λ‹¤:

1. **Docker Compose**λ΅ PostgreSQL 16 μ„¤μ • β…
2. **μ‹¤μ  λ°μ΄ν„°λ² μ΄μ¤** μ—°λ™ ν…μ¤νΈ β…  
3. **ν¬κ΄„μ μΈ κ²€μ¦** μ‹μ¤ν… β…
4. **μλ™ν™”λ ν…μ¤νΈ** μ¤ν¬λ¦½νΈ β…

λ¨λ“  ν…μ¤νΈκ°€ ν†µκ³Όν•μ—¬ μ‹¤μ  ν™κ²½μ—μ„μ μ•μ •μ„±μ΄ κ²€μ¦λμ—μµλ‹λ‹¤.